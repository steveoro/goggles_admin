%ul.nav.nav-tabs
  = content_tag( :li, link_to(t('admin_import.step_1'), di_step1_status_path()), class: 'active' )
  = content_tag( :li, link_to(t('admin_import.step_1_1'), '#'), class: 'active' )
  = content_tag( :li, link_to(t('admin_import.step_2'), '#'),   class: 'disabled' )
  = content_tag( :li, link_to(t('admin_import.step_3'), '#'),   class: 'disabled' )

.col-xs-12.goggles-category-gap

%p.text-center.lead
  = I18n.t('admin_import.import_event_results_title')
  \:
  \#{I18n.t('admin_import.team_analysis_results')}
  (#{I18n.t('admin_import.session')}: #{@data_import_session.id})

.row.col-xs-12
  .alert.alert-info
    = I18n.t('admin_import.unconfirmed_results_will_be_added')

.row.col-xs-12
  = form_tag( 'step1_1_team_analysis_commit', multipart: true, class: 'form',     |
        onsubmit: "$('#loadingIndicator').show(); " ) do                          |
    = hidden_field_tag( :data_import_session_id, @data_import_session.id )
    = hidden_field_tag( :force_meeting_creation, @force_missing_meeting_creation ? '1' : '0' )
    = hidden_field_tag( :force_team_or_swimmer_creation, @force_team_or_swimmer_creation ? '1' : '0' )
    .row.col-xs-12
      %table.table.table-striped.table-bordered.table-hover.table-condensed#history
        %tbody
          %tr.text-center
            %td{ colspan: 2 }
              = I18n.t('admin_import.searched_team')
            %td{ colspan: 2 }
              = I18n.t('admin_import.team_match_name')
            %td
              = I18n.t('admin_import.add_alias')
            %td
              = I18n.t('admin_import.add_team')
            %td
              = I18n.t('admin_import.add_affiliation')
            %td
              = I18n.t('admin_import.is_ok')
          - @analysis_results.each_with_index do |result_row, idx|
            - do_insert_alias = result_row.can_insert_alias
            - do_insert_team = result_row.can_insert_team
            - do_insert_affiliation = result_row.can_insert_affiliation
            %tr
              %td{ colspan: 2 }
                .dropdown
                  %a.dropdown-toggle{ 'data-toggle' => "dropdown", href: "#" }
                    %b="#{result_row.searched_team_name}"
                  %ul.dropdown-menu
                    - if @data_import_session
                      - data_lines = @data_import_session.source_data.split("\r\n")
                      - data_lines = data_lines.map { |line| ( line =~ Regexp.new(result_row.searched_team_name, 'ui') ) ? line[(line =~ /([a-z]+)/i).to_i .. 76] : nil }.compact.uniq
                      - 2.times { data_lines.delete_at(                           |
                          data_lines.find_index( data_lines.last )                |
                        ) } if data_lines && data_lines.size > 2                  |
                      - data_lines.each do |line|
                        %li
                          %pre.imported_swimmer= line
              %td{ colspan: 2 }
                = select( :alias_ids, result_row.id, Team.to_dropdown(),                   |
                  { prompt: I18n.t(:please_select), selected: result_row.chosen_team_id }, |
                  { class: 'input-xlarge combobox' } )                                     |
              %td
                = show_tag( do_insert_alias )
              %td
                = show_tag( do_insert_team )
              %td
                = show_tag( do_insert_affiliation )
              %td
                = check_box_tag( "id_#{result_row.id}", '1', do_insert_team )

    .row.col-xs-12.goggles-category-gap
      .col-xs-4
        = I18n.t('admin_import.on_commit_go_back_to_step1')
      .col-xs-1
        = check_box_tag( "must_go_back" )
      .col-xs-1
        = submit_tag( I18n.t('admin_import.confirm'), data: {disable_with: I18n.t(:please_wait), class: 'btn disabled'}, class: 'btn btn-primary' )
    .row.col-xs-12
      %span#loadingIndicator{hidden: "true"}
        = image_tag( 'indicator.gif' )
      #divProgress.progress.progress-striped.active{hidden: "true"}

%script
  $('.combobox').combobox();
